<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reporte Diario y Semanal</title>
  <!-- No se requiere frameworks, todo inline -->
  <style>
    /* --- ESTILOS GENERALES --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #000;
      margin: 0;
      overflow: hidden; /* manejaremos scroll interno en contenedores */
    }
    h2, h3, h4 {
      margin-bottom: 0.5rem;
    }
    .hidden { display: none !important; }
    .locked {
      pointer-events: none;
      opacity: 0.6;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* --- SIDEBAR DE PESTAÑAS (TABS) --- */
    .sidebar {
      width: 220px;
      background: #333;
      color: #fff;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding-top: 1rem;
      overflow-y: auto;
    }
    .sidebar button {
      width: 100%;
      padding: 1rem;
      background: transparent;
      color: #fff;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 1rem;
      border-bottom: 1px solid #444;
      transition: background 0.3s;
    }
    .sidebar button:hover {
      background: #444;
    }
    .sidebar button.active {
      background: #555;
      font-weight: bold;
    }

    /* --- CONTENIDO PRINCIPAL --- */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- NAV SUPERIOR (PIN, RESET, ETC.) --- */
    .top-bar {
      background: #eee;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #ccc;
    }
    .top-bar .btnLock {
      background: #bbb;
      padding: 0.5rem 1rem;
      border: none;
      cursor: pointer;
    }

    /* --- SCROLL INTERNO DEL CONTENIDO --- */
    .scroll-area {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #fff;
    }

    /* --- TABLA DE PÁGINAS DIARIAS --- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    table thead th {
      background: #f0f0f0;
      border-bottom: 2px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    table td, table th {
      padding: 0.5rem;
      border-bottom: 1px solid #ddd;
    }
    .btnRemove {
      background: red;
      color: #fff;
      border: none;
      cursor: pointer;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }

    /* --- CAMPOS DE TOTLES / CUADRE / ETC. --- */
    .totals-section, .cuadre-section {
      border: 2px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }
    .form-group {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .form-group label {
      width: 120px;
      font-weight: bold;
      margin-right: 0.5rem;
    }
    .form-group input {
      width: 120px;
      padding: 0.3rem;
      text-align: right;
    }

    /* Colores específicos: */
    .text-red { color: red; }
    .text-green { color: green; }
    .text-blue { color: blue; }
    .text-purple { color: purple; }
    .text-orange { color: orange; }

    /* --- MODAL DE PREMIOS PENDIENTES/PAGADOS --- */
    .modal-overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }
    .modal {
      background: #fff;
      padding: 1rem;
      width: 90%;
      max-width: 400px;
      border-radius: 8px;
      position: relative;
    }
    .modal h3 {
      margin-bottom: 0.5rem;
    }
    .modal table {
      width: 100%;
      margin: 0.5rem 0;
    }
    .modal table td {
      border: none;
    }
    .closeModal {
      position: absolute;
      top: 8px;
      right: 8px;
      cursor: pointer;
      background: #888;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
    }

    /* --- MODAL DE PIN --- */
    .pin-overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999999;
    }
    .pin-dialog {
      background: #fff;
      width: 300px;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
    }
    .pin-dialog input {
      font-size: 2rem;
      text-align: center;
      width: 100%;
      margin-bottom: 1rem;
    }
    .pin-dialog button {
      font-size: 1.2rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }

    /* --- BOTONES FLOTANTES O ZONA DE CONTROLES --- */
    .actions {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    /* --- ESTILOS DE LA PESTAÑA "MANUAL" --- */
    .manual-content h4 {
      margin-top: 1rem;
      margin-bottom: 0.2rem;
      color: #333;
    }
    .manual-content p {
      margin-bottom: 0.8rem;
      line-height: 1.4;
    }

    /* Estilo del botón Exportar PDF */
    .btnExportPDF {
      background: #666;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- CAPA DE PIN / ACCESO -->
  <div class="pin-overlay" id="pinOverlay">
    <div class="pin-dialog">
      <h2>Ingrese PIN (4 dígitos)</h2>
      <input type="password" id="pinInput" maxlength="4" />
      <button id="btnPinSubmit">Acceder</button>
    </div>
  </div>

  <!-- CONTENEDOR PRINCIPAL (sidebar + main content) -->
  <div class="container hidden" id="mainContainer">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <!-- 7 días, 1 semanal, 1 manual => 9 tabs -->
      <button class="tabBtn active" data-tab="tabDay1">Lunes (mm/dd/aaaa)</button>
      <button class="tabBtn" data-tab="tabDay2">Martes (mm/dd/aaaa)</button>
      <button class="tabBtn" data-tab="tabDay3">Miércoles (mm/dd/aaaa)</button>
      <button class="tabBtn" data-tab="tabDay4">Jueves (mm/dd/aaaa)</button>
      <button class="tabBtn" data-tab="tabDay5">Viernes (mm/dd/aaaa)</button>
      <button class="tabBtn" data-tab="tabDay6">Sábado (mm/dd/aaaa)</button>
      <button class="tabBtn" data-tab="tabDay7">Domingo (mm/dd/aaaa)</button>
      <button class="tabBtn" data-tab="tabWeekly">Resumen Semanal</button>
      <button class="tabBtn" data-tab="tabManual">Manual</button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- TOP BAR -->
      <div class="top-bar">
        <div>
          <button class="btnLock" id="btnLockAll">Bloquear Todo</button>
          <button class="btnLock" id="btnUnlockAll">Desbloquear</button>
          <button class="btnExportPDF" id="btnExportPDF">Exportar PDF</button>
        </div>
        <button id="btnResetWeek" style="background:#f90;color:#fff;border:none;padding:0.5rem 1rem;">Reset Semana</button>
      </div>

      <!-- AREA DE SCROLL (las tabs) -->
      <div class="scroll-area">
        <!-- Cada tab es un div oculto excepto el primero -->
        <!-- TAB DIA1 -->
        <div id="tabDay1" class="tabContent">
          <h2>Reporte Diario - Lunes</h2>
          <div class="actions">
            <button onclick="addPageRow('day1')">+ Agregar Página</button>
            <button onclick="sendDayToSheets('day1')">Enviar a Sheets</button>
            <button onclick="resetDay('day1')">Reset (Día)</button>
          </div>
          <div id="day1Container">
            <!-- Se genera tabla dinámica (páginas) -->
          </div>
        </div>

        <!-- TAB DIA2 -->
        <div id="tabDay2" class="tabContent hidden">
          <h2>Reporte Diario - Martes</h2>
          <div class="actions">
            <button onclick="addPageRow('day2')">+ Agregar Página</button>
            <button onclick="sendDayToSheets('day2')">Enviar a Sheets</button>
            <button onclick="resetDay('day2')">Reset (Día)</button>
          </div>
          <div id="day2Container"></div>
        </div>

        <!-- TAB DIA3 -->
        <div id="tabDay3" class="tabContent hidden">
          <h2>Reporte Diario - Miércoles</h2>
          <div class="actions">
            <button onclick="addPageRow('day3')">+ Agregar Página</button>
            <button onclick="sendDayToSheets('day3')">Enviar a Sheets</button>
            <button onclick="resetDay('day3')">Reset (Día)</button>
          </div>
          <div id="day3Container"></div>
        </div>

        <!-- TAB DIA4 -->
        <div id="tabDay4" class="tabContent hidden">
          <h2>Reporte Diario - Jueves</h2>
          <div class="actions">
            <button onclick="addPageRow('day4')">+ Agregar Página</button>
            <button onclick="sendDayToSheets('day4')">Enviar a Sheets</button>
            <button onclick="resetDay('day4')">Reset (Día)</button>
          </div>
          <div id="day4Container"></div>
        </div>

        <!-- TAB DIA5 -->
        <div id="tabDay5" class="tabContent hidden">
          <h2>Reporte Diario - Viernes</h2>
          <div class="actions">
            <button onclick="addPageRow('day5')">+ Agregar Página</button>
            <button onclick="sendDayToSheets('day5')">Enviar a Sheets</button>
            <button onclick="resetDay('day5')">Reset (Día)</button>
          </div>
          <div id="day5Container"></div>
        </div>

        <!-- TAB DIA6 -->
        <div id="tabDay6" class="tabContent hidden">
          <h2>Reporte Diario - Sábado</h2>
          <div class="actions">
            <button onclick="addPageRow('day6')">+ Agregar Página</button>
            <button onclick="sendDayToSheets('day6')">Enviar a Sheets</button>
            <button onclick="resetDay('day6')">Reset (Día)</button>
          </div>
          <div id="day6Container"></div>
        </div>

        <!-- TAB DIA7 -->
        <div id="tabDay7" class="tabContent hidden">
          <h2>Reporte Diario - Domingo</h2>
          <div class="actions">
            <button onclick="addPageRow('day7')">+ Agregar Página</button>
            <button onclick="sendDayToSheets('day7')">Enviar a Sheets</button>
            <button onclick="resetDay('day7')">Reset (Día)</button>
          </div>
          <div id="day7Container"></div>
        </div>

        <!-- TAB SEMANAL -->
        <div id="tabWeekly" class="tabContent hidden">
          <h2>Resumen Semanal</h2>
          <div class="actions">
            <button onclick="sendWeekToSheets()">Guardar Semana</button>
          </div>
          <div id="weeklyContainer">
            <!-- Contenido de la semana (sumas) -->
          </div>
        </div>

        <!-- TAB MANUAL -->
        <div id="tabManual" class="tabContent hidden">
          <h2>Manual / Ayuda</h2>
          <div class="manual-content">
            <h4>Objetivo</h4>
            <p>Este módulo registra las ventas (centenas, pulitos) y salidas de premios diarios, para luego consolidar en un reporte semanal.</p>

            <h4>Uso Diario</h4>
            <p>Cada pestaña (Lunes a Domingo) corresponde a un día. Se pueden añadir “Páginas” (lotes de tickets). En cada fila se registran:</p>
            <ul>
              <li><strong>Centenas</strong>: Monto en la columna de cientos.</li>
              <li><strong>Pulitos</strong>: Monto en la columna de pulitos.</li>
              <li><strong>Salidas</strong>: Premiación total (con la posibilidad de desglosar en <em>pendientes</em> y <em>pagados</em>).</li>
              <li><strong>Total</strong>: Suma de Centenas + Pulitos.</li>
            </ul>

            <h4>Cuadre del Día</h4>
            <p>Al final de la tabla, se encuentran los totales de Centenas, Pulitos, Salidas y un “Cuadre” con diferentes campos (Cash, Sucursal, etc.) para balancear hasta lograr un <em>Net Balance</em> = 0 (idealmente).</p>

            <h4>Resumen Semanal</h4>
            <p>La octava pestaña muestra la suma de todos los días (Lunes-Domingo). Allí se calcula también la comisión y un <em>Balance Oficina</em> según tus reglas (25% de Centenas, 10% de Pulitos, etc.).</p>

            <h4>Botones y Funcionalidades</h4>
            <ul>
              <li><em>Enviar a Sheets</em>: Llama a una función para subir datos a Google Sheets o AppSheet.</li>
              <li><em>Reset</em>: Borra la data de ese día o de toda la semana en localStorage.</li>
              <li><em>Bloquear</em>: Evita edición accidental; <em>Desbloquear</em> para reactivar.</li>
              <li><em>Exportar PDF</em>: Genera un PDF o imagen del estado actual.</li>
            </ul>

            <h4>Salidas: Premios Pendientes/Pagados</h4>
            <p>Al hacer clic en la celda “Salidas” de una fila, se abre un modal. Allí puedes ingresar varias líneas de premios <strong>pendientes</strong> (morado) o <strong>pagados</strong> (rojo). La suma total aparece en la tabla. Si hay pendientes, la celda se pinta de morado; si todo está pagado, se pinta de rojo.</p>

            <h4>Más Detalles</h4>
            <p>Puedes editar manualmente el campo de “Caídas” en el resumen semanal (aunque se calcule automático). De igual forma, se guardan los datos en localStorage hasta que resetees.</p>

          </div>
        </div>

      </div> <!-- scroll-area -->

    </div> <!-- main-content -->
  </div> <!-- container -->


  <!-- MODAL PREMIOS PEND/PAG -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="prizesModal">
      <button class="closeModal" id="closePrizeModal">X</button>
      <h3>Premios de la Página <span id="prizeModalPageNo"></span></h3>
      <div style="display:flex;gap:1rem;flex-wrap:wrap;">
        <!-- Lista de PENDIENTES -->
        <div style="flex:1; min-width:150px;">
          <h4 style="color:purple">Pendientes</h4>
          <table>
            <tbody id="pendingTbody"></tbody>
          </table>
          <button onclick="addPrizeRow('pending')">+ Pendiente</button>
        </div>
        <!-- Lista de PAGADOS -->
        <div style="flex:1; min-width:150px;">
          <h4 style="color:red">Pagados</h4>
          <table>
            <tbody id="paidTbody"></tbody>
          </table>
          <button onclick="addPrizeRow('paid')">+ Pagado</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    /***********************************************************
     * SCRIPTS PRINCIPALES
     * - Manejamos localStorage para cada día y la semana
     * - 9 tabs: Lunes..Domingo, Semanal, Manual
     * - Pin code: 8325
     ***********************************************************/

    const PIN_CODE = "8325";

    let currentTab = "tabDay1";
    let lockedAll = false;

    // Estructura para guardar datos: day1, day2, ... day7, weekly
    // Cada dayN => { pages:[], overlook:0, ...?
    // Each page => { pageNo, centenas, pulitos, pendingPrizes:[], paidPrizes:[], total, ...}
    let dataStore = {
      day1:{ pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 },
      day2:{ pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 },
      day3:{ pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 },
      day4:{ pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 },
      day5:{ pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 },
      day6:{ pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 },
      day7:{ pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 },
      weekly:{
        //Lo que requieras: caidas, etc
        caidas:0,
        adelantoOficina:0
      }
    };


    /***********************************************************
     *  AL CARGAR -> VERIFICAR localStorage y PIN
     ***********************************************************/
    window.addEventListener("DOMContentLoaded", ()=>{
      // Revisar si existe data en localStorage
      let stored = localStorage.getItem("dailyReportData");
      if(stored){
        dataStore = JSON.parse(stored);
      }
      // Pintar la interfaz
      initAllDays();
      updateWeeklyView();
      // Manejo de tabs
      initTabs();
      // Manejo de candado
      initLockButtons();
      // Manejo PDF
      document.getElementById("btnExportPDF").addEventListener("click", exportPDF);
      // Botón reset semana
      document.getElementById("btnResetWeek").addEventListener("click", resetWeek);
      // Manejo PIN
      initPinOverlay();
    });


    function initPinOverlay(){
      //El pinOverlay está visible. Hasta que se introduzca el PIN correcto no se muestra la app
      const pinOverlay = document.getElementById("pinOverlay");
      const mainContainer = document.getElementById("mainContainer");
      const btnPin = document.getElementById("btnPinSubmit");
      btnPin.addEventListener("click", ()=>{
        const val = document.getElementById("pinInput").value.trim();
        if(val===PIN_CODE){
          //Acceso concedido
          pinOverlay.style.display = "none";
          mainContainer.classList.remove("hidden");
        }else{
          alert("PIN incorrecto");
        }
      });
    }

    /***********************************************************
     *  TABS
     ***********************************************************/
    function initTabs(){
      const tabBtns = document.querySelectorAll(".tabBtn");
      tabBtns.forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          // quitar active de todos
          tabBtns.forEach(b=> b.classList.remove("active"));
          e.target.classList.add("active");
          // esconder todos tabContent
          document.querySelectorAll(".tabContent").forEach(tc => tc.classList.add("hidden"));
          // mostrar la que corresponde
          const targetId = e.target.dataset.tab;
          currentTab = targetId;
          document.getElementById(targetId).classList.remove("hidden");
        });
      });
    }

    /***********************************************************
     *  INICIALIZAR (O RE-DIBUJAR) LOS 7 DÍAS
     ***********************************************************/
    function initAllDays(){
      for(let i=1; i<=7; i++){
        renderDay("day"+i);
      }
    }

    /***********************************************************
     *  RENDERIZAR UN DÍA
     ***********************************************************/
    function renderDay(dayKey){
      // day1Container, day2Container, etc.
      const container = document.getElementById(dayKey+"Container");
      if(!container) return;
      const dayData = dataStore[dayKey];

      // construimos HTML => tabla con pages, totales, cuadro
      let html = `
        <table>
          <thead>
            <tr>
              <th>#Página</th>
              <th>Centenas</th>
              <th>Pulitos</th>
              <th>Salidas</th>
              <th>Total</th>
              <th>Eliminar</th>
            </tr>
          </thead>
          <tbody>
      `;
      dayData.pages.forEach((p, idx)=>{
        html += `
          <tr>
            <td>${p.pageNo}</td>
            <td><input type="number" value="${p.centenas||0}" data-day="${dayKey}" data-pindex="${idx}" data-field="centenas" oninput="updatePageField(this)"></td>
            <td><input type="number" value="${p.pulitos||0}" data-day="${dayKey}" data-pindex="${idx}" data-field="pulitos" oninput="updatePageField(this)"></td>
            <td>
              <div style="cursor:pointer; color:${(p.pendingPrizes&&p.pendingPrizes.length>0)?'purple':'red'}" onclick="openPrizesModal('${dayKey}', ${idx})">
                $${(p.totalSalidas||0).toFixed(2)}
              </div>
            </td>
            <td>${(p.centenas + p.pulitos).toFixed(2)}</td>
            <td><button class="btnRemove" onclick="deletePageRow('${dayKey}', ${idx})">X</button></td>
          </tr>
        `;
      });
      html += `
          </tbody>
        </table>
      `;

      // TOTALSECTION
      let totals = calcDayTotals(dayKey);
      html += `
        <div class="totals-section">
          <h3>Totales</h3>
          <p><strong>Total Centenas:</strong> $${totals.totalCentenas.toFixed(2)}</p>
          <p><strong>Total Pulitos:</strong> $${totals.totalPulitos.toFixed(2)}</p>
          <p><strong>Overlook:</strong> <input type="number" value="${dayData.overlook||0}" style="width:80px;" data-day="${dayKey}" data-field="overlook" oninput="updateDayField(this)" /></p>
          <p><strong>Total Salidas:</strong> <span style="color:red;">$${totals.totalSalidas.toFixed(2)}</span></p>
          <p><strong>Total Ventas (Centenas + Pulitos):</strong> $${totals.totalVentas.toFixed(2)}</p>
        </div>
      `;

      // CUADRE
      // Subtotal = Ventas - Salidas
      let subT = totals.totalVentas - totals.totalSalidas;
      let colorST = "purple";
      // Campos varios: Cash, Sucursal, Credito, Descuento, Tickets
      let dayCash = dayData.cash||0;
      let daySucursal = dayData.sucursal||0;
      let dayCredito = dayData.credito||0;
      let dayDesc = dayData.descuento||0;
      let dayTickets = dayData.tickets||0;
      // netBalance = subT - (cash + sucursal + credito + descuento + tickets) (puedes ajustar la lógica)
      let nb = subT - (dayCash + daySucursal + dayCredito + dayDesc + dayTickets);
      let nbColor = nb===0?"black":(nb<0?"red":"blue");

      html += `
        <div class="cuadre-section">
          <h3>Cuadre del Día</h3>
          <div class="form-group">
            <label>Ventas</label>
            <input type="text" readonly value="${totals.totalVentas.toFixed(2)}" />
          </div>
          <div class="form-group">
            <label>Salidas</label>
            <input type="text" readonly value="${totals.totalSalidas.toFixed(2)}" style="color:red;" />
          </div>
          <div class="form-group">
            <label>Sub Total</label>
            <input type="text" readonly style="color:${colorST};" value="${subT.toFixed(2)}" />
          </div>
          <!-- Campos con botoncito "X" se omite para la demo, 
               pero si quieres, cada uno podría tener su delete. -->
          <div class="form-group">
            <label>Cash</label>
            <input type="number" data-day="${dayKey}" data-field="cash" value="${dayCash}" oninput="updateDayField(this)" style="color:green;" />
          </div>
          <div class="form-group">
            <label>Sucursal</label>
            <input type="number" data-day="${dayKey}" data-field="sucursal" value="${daySucursal}" oninput="updateDayField(this)" />
          </div>
          <div class="form-group">
            <label>Crédito</label>
            <input type="number" data-day="${dayKey}" data-field="credito" value="${dayCredito}" oninput="updateDayField(this)" />
          </div>
          <div class="form-group">
            <label>Descuento</label>
            <input type="number" data-day="${dayKey}" data-field="descuento" value="${dayDesc}" oninput="updateDayField(this)" />
          </div>
          <div class="form-group">
            <label>Tickets</label>
            <input type="number" data-day="${dayKey}" data-field="tickets" value="${dayTickets}" oninput="updateDayField(this)" />
          </div>
          <div class="form-group">
            <label>Net Balance</label>
            <input type="text" readonly value="${nb.toFixed(2)}" style="color:${nbColor}" />
          </div>
        </div>
      `;

      container.innerHTML = html;
    }


    function calcDayTotals(dayKey){
      const dayData = dataStore[dayKey];
      let totalCentenas=0, totalPulitos=0, totalSalidas=0;
      dayData.pages.forEach(p=>{
        totalCentenas += (p.centenas||0);
        totalPulitos += (p.pulitos||0);
        totalSalidas += (p.totalSalidas||0);
      });
      totalSalidas += (dayData.overlook||0);

      let totalVentas = totalCentenas + totalPulitos;
      return {
        totalCentenas, totalPulitos, totalSalidas, totalVentas
      };
    }

    /***********************************************************
     *  CAMBIO DE UN CAMPO EN LA TABLA DE PAGINAS
     ***********************************************************/
    function updatePageField(input){
      const dayKey = input.dataset.day;
      const pindex = parseInt(input.dataset.pindex);
      const field = input.dataset.field;
      let val = parseFloat(input.value)||0;
      dataStore[dayKey].pages[pindex][field] = val;
      // Recalcular totales
      renderDay(dayKey);
      storeData();
    }

    function updateDayField(input){
      const dayKey = input.dataset.day;
      const field = input.dataset.field;
      let val = parseFloat(input.value)||0;
      dataStore[dayKey][field] = val;
      renderDay(dayKey);
      storeData();
    }

    /***********************************************************
     *  AGREGAR FILA (PAGINA) AL DIA
     ***********************************************************/
    function addPageRow(dayKey){
      let dayData = dataStore[dayKey];
      let newPageNo = dayData.pages.length+1;
      dayData.pages.push({
        pageNo: newPageNo,
        centenas:0,
        pulitos:0,
        totalSalidas:0,
        pendingPrizes:[],
        paidPrizes:[]
      });
      renderDay(dayKey);
      storeData();
    }
    function deletePageRow(dayKey, idx){
      if(!confirm("¿Eliminar esta página?")) return;
      dataStore[dayKey].pages.splice(idx,1);
      // Reordenar pageNo
      dataStore[dayKey].pages.forEach((p, i)=> p.pageNo = i+1);
      renderDay(dayKey);
      storeData();
    }

    /***********************************************************
     *  PREMIO PENDIENTE / PAGADO => MODAL
     ***********************************************************/
    let currentDayKeyForModal="";
    let currentPageIndex=0;

    function openPrizesModal(dayKey, pindex){
      currentDayKeyForModal = dayKey;
      currentPageIndex = pindex;
      const pageData = dataStore[dayKey].pages[pindex];
      document.getElementById("prizeModalPageNo").textContent = pageData.pageNo;
      // Pintar las tablas pending / paid
      paintPrizeLists();
      // mostrar modal
      document.getElementById("modalOverlay").style.display = "flex";
    }

    function paintPrizeLists(){
      const pageData = dataStore[currentDayKeyForModal].pages[currentPageIndex];
      const pendingTbody = document.getElementById("pendingTbody");
      const paidTbody = document.getElementById("paidTbody");

      // pending
      let pendingHTML = "";
      (pageData.pendingPrizes||[]).forEach((val, idx)=>{
        pendingHTML += `
          <tr>
            <td style="width:70px;">
              <input type="number" value="${val}" style="width:60px;" oninput="updatePrizeValue(${idx}, 'pending', this.value)">
            </td>
            <td>
              <button style="background:orange;" onclick="movePrizeToPaid(${idx}, 'pending')">→ Pagado</button>
              <button style="background:red;color:#fff;" onclick="deletePrize(${idx}, 'pending')">X</button>
            </td>
          </tr>
        `;
      });
      pendingTbody.innerHTML = pendingHTML;

      // paid
      let paidHTML = "";
      (pageData.paidPrizes||[]).forEach((val, idx)=>{
        paidHTML += `
          <tr>
            <td style="width:70px;">
              <input type="number" value="${val}" style="width:60px;" oninput="updatePrizeValue(${idx}, 'paid', this.value)">
            </td>
            <td>
              <button style="background:purple;color:#fff;" onclick="movePrizeToPaid(${idx}, 'paid')">← Pend</button>
              <button style="background:red;color:#fff;" onclick="deletePrize(${idx}, 'paid')">X</button>
            </td>
          </tr>
        `;
      });
      paidTbody.innerHTML = paidHTML;
      // Recalcular totalSalidas
      recalcPageSalidas();
    }

    function addPrizeRow(type){
      const pageData = dataStore[currentDayKeyForModal].pages[currentPageIndex];
      if(type==="pending"){
        pageData.pendingPrizes.push(0);
      } else {
        pageData.paidPrizes.push(0);
      }
      paintPrizeLists();
      storeData();
    }
    function updatePrizeValue(idx, type, val){
      const pageData = dataStore[currentDayKeyForModal].pages[currentPageIndex];
      let arr = (type==="pending")? pageData.pendingPrizes : pageData.paidPrizes;
      arr[idx] = parseFloat(val)||0;
      recalcPageSalidas();
      storeData();
    }
    function deletePrize(idx, type){
      const pageData = dataStore[currentDayKeyForModal].pages[currentPageIndex];
      let arr = (type==="pending")? pageData.pendingPrizes : pageData.paidPrizes;
      arr.splice(idx,1);
      paintPrizeLists();
      storeData();
    }
    function movePrizeToPaid(idx, fromType){
      const pageData = dataStore[currentDayKeyForModal].pages[currentPageIndex];
      if(fromType==="pending"){
        let val = pageData.pendingPrizes[idx];
        pageData.pendingPrizes.splice(idx,1);
        pageData.paidPrizes.push(val);
      } else {
        let val = pageData.paidPrizes[idx];
        pageData.paidPrizes.splice(idx,1);
        pageData.pendingPrizes.push(val);
      }
      paintPrizeLists();
      storeData();
    }
    function recalcPageSalidas(){
      const pageData = dataStore[currentDayKeyForModal].pages[currentPageIndex];
      let sumPend = (pageData.pendingPrizes||[]).reduce((acc,v)=> acc+v,0);
      let sumPaid = (pageData.paidPrizes||[]).reduce((acc,v)=> acc+v,0);
      pageData.totalSalidas = sumPend + sumPaid;
      storeData();
      renderDay(currentDayKeyForModal);
    }

    // Cerrar modal
    document.getElementById("closePrizeModal").addEventListener("click", ()=>{
      document.getElementById("modalOverlay").style.display = "none";
    });


    /***********************************************************
     *  BOTONES DE GUARDAR A SHEETS / RESET
     ***********************************************************/
    function sendDayToSheets(dayKey){
      // placeholder para tu fetch/POST a Google Sheets
      alert("Enviar datos de " + dayKey + " a Google Sheets (placeholder).");
    }
    function resetDay(dayKey){
      if(!confirm("¿Resetear todos los datos del día?")) return;
      dataStore[dayKey] = { pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 };
      renderDay(dayKey);
      storeData();
    }
    function sendWeekToSheets(){
      // placeholder
      alert("Enviar la semana completa a Google Sheets (placeholder).");
    }
    function resetWeek(){
      if(!confirm("¿Borrar toda la semana (todos los días) y empezar de cero?")) return;
      for(let i=1; i<=7; i++){
        dataStore["day"+i] = { pages:[], overlook:0, cash:0, sucursal:0, credito:0, descuento:0, tickets:0, netBalance:0 };
      }
      dataStore.weekly={ caidas:0, adelantoOficina:0 };
      initAllDays();
      updateWeeklyView();
      storeData();
    }

    /***********************************************************
     *  SEMANA (TAB WEEKLY)
     ***********************************************************/
    function updateWeeklyView(){
      const wCont = document.getElementById("weeklyContainer");
      if(!wCont) return;
      // Calcular totales de day1..day7
      let dayTotals = [];
      let grandCent=0, grandPul=0, grandSal=0, grandVent=0;
      for(let i=1; i<=7; i++){
        let dKey = "day"+i;
        let t = calcDayTotals(dKey);
        grandCent += t.totalCentenas;
        grandPul  += t.totalPulitos;
        grandSal  += t.totalSalidas;
        grandVent += t.totalVentas;
        dayTotals.push(t);
      }

      //Comisiones: 25% de Centenas, 10% de Pulitos
      let c25 = grandCent*0.25;
      let p10 = grandPul*0.10;
      let totalComision = c25 + p10;
      let totalSalidas = grandSal;
      let subTotal = grandVent - (totalSalidas + totalComision);

      // Caidas (puede modificarse a mano)
      let caidas = dataStore.weekly.caidas||0;
      // AdelantoOficina
      let adelanto = dataStore.weekly.adelantoOficina||0;

      let balanceOficina = subTotal - caidas - adelanto;
      let balColor = balanceOficina===0?"black":(balanceOficina<0?"red":"blue");

      let html = `
      <h3>Totales Semanales (Lunes-Domingo)</h3>
      <table>
        <thead>
          <tr>
            <th>Dia</th>
            <th>Centenas</th>
            <th>Pulitos</th>
            <th>Salidas</th>
            <th>Ventas</th>
          </tr>
        </thead>
        <tbody>
      `;
      const dayNames=["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
      for(let i=0; i<7; i++){
        html += `
          <tr>
            <td>${dayNames[i]}</td>
            <td>$${dayTotals[i].totalCentenas.toFixed(2)}</td>
            <td>$${dayTotals[i].totalPulitos.toFixed(2)}</td>
            <td style="color:red;">$${dayTotals[i].totalSalidas.toFixed(2)}</td>
            <td>$${dayTotals[i].totalVentas.toFixed(2)}</td>
          </tr>
        `;
      }
      html += `
        <tr style="font-weight:bold;">
          <td>Totales</td>
          <td>$${grandCent.toFixed(2)}</td>
          <td>$${grandPul.toFixed(2)}</td>
          <td style="color:red;">$${grandSal.toFixed(2)}</td>
          <td>$${grandVent.toFixed(2)}</td>
        </tr>
        </tbody>
      </table>

      <div class="cuadre-section">
        <h3>Cuadre Semanal</h3>
        <p><strong>Total Ventas:</strong> $${grandVent.toFixed(2)}</p>
        <p><strong>Centenas 25%:</strong> $${c25.toFixed(2)}</p>
        <p><strong>Pulitos 10%:</strong> $${p10.toFixed(2)}</p>
        <p><strong>Total Comision:</strong> $${totalComision.toFixed(2)}</p>
        <p><strong>Total Salidas:</strong> <span style="color:red;">$${totalSalidas.toFixed(2)}</span></p>
        <p><strong>Sub Total (Ventas - Salidas - Comisión):</strong> $${subTotal.toFixed(2)}</p>
        <p>
          <label>Caídas (20% aprox):</label>
          <input type="number" style="width:100px;" value="${caidas}"
                 oninput="updateWeeklyField('caidas', this.value)" />
        </p>
        <p>
          <label>Adelanto Oficina:</label>
          <input type="number" style="width:100px;" value="${adelanto}"
                 oninput="updateWeeklyField('adelantoOficina', this.value)" />
        </p>
        <p><strong>Balance Oficina:</strong>
          <span style="color:${balColor};">$${balanceOficina.toFixed(2)}</span>
        </p>
      </div>
      `;
      wCont.innerHTML = html;
    }

    function updateWeeklyField(field, val){
      dataStore.weekly[field] = parseFloat(val)||0;
      storeData();
      updateWeeklyView();
    }

    /***********************************************************
     *  GUARDAR / CARGAR localStorage
     ***********************************************************/
    function storeData(){
      localStorage.setItem("dailyReportData", JSON.stringify(dataStore));
      // actualizar la vista semanal
      updateWeeklyView();
    }

    /***********************************************************
     *  BLOQUEO / DESBLOQUEO
     ***********************************************************/
    function initLockButtons(){
      document.getElementById("btnLockAll").addEventListener("click", ()=>{
        lockedAll = true;
        document.querySelector(".main-content").classList.add("locked");
      });
      document.getElementById("btnUnlockAll").addEventListener("click", ()=>{
        lockedAll = false;
        document.querySelector(".main-content").classList.remove("locked");
      });
    }

    /***********************************************************
     *  EXPORTAR PDF (html2canvas)
     ***********************************************************/
    function exportPDF(){
      alert("Generando captura... Espere un momento.");
      html2canvas(document.querySelector(".scroll-area"), {scale:1.5})
      .then(canvas=>{
        let link = document.createElement("a");
        link.download = "ReporteDiarioSemanal.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      })
      .catch(err=>{
        console.error(err);
        alert("Error al generar la imagen/PDF.");
      });
    }

  </script>

</body>
</html>
