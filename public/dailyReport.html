 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BeastBet - 4 Semanas (Ne√≥n/Dark)</title>

  <style>
    /* =============== RESET & BASE =============== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Paleta de colores (ne√≥n/dark) */
      --main-bg: #111;             /* fondo oscuro */
      --main-text: #eee;           /* texto claro */
      --accent-color: #0ff;        /* cian ne√≥n */
      --danger-color: #f33;        /* rojo ne√≥n */
      --lock-color: #fb0;          /* amarillo candado */
      --purple-color: #a0f;        /* morado para pendientes */
      --purple-strong: #ff00ff;    /* morado fuerte (subTotal) */
      --shared-tab-bg: #222;       /* fondo secciones / tablas */
    }

    body {
      background: var(--main-bg);
      color: var(--main-text);
      font-family: 'Segoe UI', Tahoma, sans-serif;
      font-size: 16px;
      overflow: hidden;
    }

    .hidden { display: none !important; }

    /* =============== LAYOUT PRINCIPAL =============== */
    .container {
      display: flex;
      width: 100vw;
      height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      width: 300px;
      background: #000;
      border-right: 2px solid var(--accent-color);
      overflow-y: auto;
      padding: 1rem;
    }
    .sidebar h2 {
      color: var(--accent-color);
      text-shadow: 0 0 3px var(--accent-color);
      margin-bottom: 1rem;
    }
    .sidebar button {
      display: block;
      width: 100%;
      margin-bottom: 0.5rem;
      padding: 0.8rem;
      background: transparent;
      border: 1px solid var(--accent-color);
      color: var(--accent-color);
      font-size: 1rem;
      cursor: pointer;
      text-shadow: 0 0 3px var(--accent-color);
      transition: background 0.3s, color 0.3s;
    }
    .sidebar button:hover {
      background: var(--accent-color);
      color: #000;
    }

    /* MAIN CONTENT (RIGHT) */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #000;  /* para ‚ÄúNe√≥n‚Äù */
    }
    .top-bar {
      background: #000;
      border-bottom: 2px solid var(--accent-color);
      padding: 0.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .top-bar h3 {
      margin: 0;
      color: var(--accent-color);
      font-size: 1.3rem;
      text-shadow: 0 0 3px var(--accent-color);
    }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #000;
    }

    /* =============== OVERLAY PIN =============== */
    .pin-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }
    .pin-dialog {
      background: #222;
      border: 2px solid var(--accent-color);
      border-radius: 10px;
      padding: 2rem;
      width: 400px;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 0 10px var(--accent-color);
      position: relative; /* para colocar el ojito dentro */
    }
    .pin-dialog h2 {
      margin-bottom: 1rem;
      color: var(--accent-color);
      font-size: 1.5rem;
      text-shadow: 0 0 5px var(--accent-color);
    }
    .pin-dialog .pinInputWrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .pin-dialog input {
      font-size: 2rem;
      text-align: center;
      width: 100%;
      background: #000;
      color: var(--accent-color);
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      padding: 0.5rem;
      box-shadow: inset 0 0 5px var(--accent-color);
    }
    .pin-dialog button {
      font-size: 1.2rem;
      padding: 0.5rem 2rem;
      background: #000;
      color: var(--accent-color);
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 5px var(--accent-color);
      margin-top: 1rem;
    }
    .pin-dialog button:hover {
      background: var(--accent-color);
      color: #000;
    }

    /* Bot√≥n ‚Äúojo‚Äù */
    .eye-toggle {
      position: absolute;
      right: 8px;
      font-size: 1.3rem;
      background: transparent;
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      text-shadow: 0 0 3px var(--accent-color);
      margin-top: 2px;
    }
    .eye-toggle:hover {
      color: #fff;
    }

    /* =============== SEMANAS (ACORDE√ìN) =============== */
    .week-header {
      background: #222;
      margin-bottom: 5px;
      padding: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #444;
      text-shadow: 0 0 2px var(--accent-color);
    }
    .week-content {
      margin-left: 10px;
      margin-bottom: 1rem;
      display: none;  /* colapsado por defecto */
    }
    .day-item {
      padding: 0.4rem;
      cursor: pointer;
      border-bottom: 1px solid #444;
      margin-left: 15px;
      font-size: 1rem;
    }
    .day-item:hover {
      background: #111;
    }

    /* Candaditos (üîì / üîí) estilo ne√≥n */
    .lockBtn {
      background: #000;
      color: var(--lock-color);
      border: 2px solid var(--lock-color);
      border-radius: 8px;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      box-shadow: 0 0 5px var(--lock-color);
      font-size: 1rem;
    }
    .lockBtn:hover {
      background: var(--lock-color);
      color: #000;
    }
    .lockBtn.locked {
      background: var(--lock-color);
      color: #000;
    }

    /* =============== TABLAS / INPUTS NE√ìN =============== */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table thead th {
      background: rgba(0,0,0,0.4);
      color: var(--accent-color);
      border-bottom: 2px solid var(--accent-color);
      text-shadow: 0 0 3px var(--accent-color);
      font-size: 1rem;
      padding: 0.5rem;
    }
    table tbody td {
      border-bottom: 1px solid #444;
      padding: 0.5rem;
      text-align: center;
      font-size: 1rem;
    }

    input[type="number"], 
    input[type="text"] {
      background: #000;
      color: var(--accent-color);
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      text-align: right;
      box-shadow: inset 0 0 5px var(--accent-color);
      font-size: 1rem;
      padding: 0.3rem;
      margin: 2px 0;
    }
    input[type="number"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: #fff;
    }

    /* Bot√≥n ‚Äúeliminar p√°gina‚Äù */
    .pageBtn {
      background: var(--danger-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 0 5px var(--danger-color);
      transition: transform 0.2s;
    }
    .pageBtn:hover {
      background: #f66;
      transform: scale(1.05);
    }

    /* Secciones Totales / Cuadre => estilo ‚Äúcaja ne√≥n‚Äù */
    .totals-section, .cuadre-section {
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #000;
      box-shadow: 0 0 8px var(--accent-color);
    }
    .totals-section h3, .cuadre-section h3 {
      color: var(--accent-color);
      margin-bottom: 1rem;
      text-shadow: 0 0 3px var(--accent-color);
      font-size: 1.2rem;
    }

    .form-group {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .form-group label {
      width: 150px;
      font-weight: bold;
      margin-right: 0.5rem;
      text-shadow: none;
      font-size: 1rem;
      color: #fff; /* un poco m√°s visible */
    }

    /* Acorde√≥n general ‚ÄúCr√©ditos‚Äù y ‚ÄúCuadre‚Äù */
    .accordion {
      margin-bottom: 1rem;
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      box-shadow: 0 0 8px var(--accent-color);
      background: #000;
    }
    .accordion-header {
      padding: 0.8rem;
      cursor: pointer;
      font-weight: bold;
      color: var(--accent-color);
      text-shadow: 0 0 3px var(--accent-color);
      border-bottom: 1px solid #444;
      font-size: 1rem;
    }
    .accordion-content {
      display: none; /* colapsada por defecto */
      padding: 1rem;
    }
    .accordion-content h4 {
      color: var(--accent-color);
      margin-bottom: 0.5rem;
      text-shadow: 0 0 3px var(--accent-color);
      font-size: 1rem;
    }

    /* Botones +Pend / +Paid */
    .addPrizeBtn {
      background: #000;
      border: 1px solid var(--purple-color);
      color: var(--purple-color);
      border-radius: 4px;
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      margin: 0.5rem 0;
      box-shadow: 0 0 5px var(--purple-color);
    }
    .addPrizeBtn:hover {
      background: var(--purple-color);
      color: #000;
    }
    .paidBtn, .pendingBtn {
      font-size: 0.9rem;
      padding: 0.2rem 0.4rem;
      cursor: pointer;
      margin-right: 0.3rem;
      border: none;
      border-radius: 4px;
      color: #fff;
    }
    .paidBtn {
      background: var(--danger-color);
      box-shadow: 0 0 3px var(--danger-color);
    }
    .pendingBtn {
      background: var(--purple-color);
      box-shadow: 0 0 3px var(--purple-color);
    }

  </style>
</head>

<body>

<!-- OVERLAY LOGIN (PIN) -->
<div class="pin-overlay" id="pinOverlay">
  <div class="pin-dialog">
    <h2>Ingrese su clave de 4 d√≠gitos</h2>

    <!-- Contenedor para el input y el ojo -->
    <div class="pinInputWrapper" style="margin-bottom:1rem;">
      <input 
        type="password" 
        id="pinInput"
        maxlength="4"
        autocomplete="off"
        autocorrect="off"
        onkeyup="if(event.key==='Enter'){ document.getElementById('btnPinSubmit').click(); }"
      />
      <button type="button" class="eye-toggle" id="togglePinView" title="Mostrar/Ocultar PIN">
        üëÅ
      </button>
    </div>

    <button id="btnPinSubmit">Acceder</button>
  </div>
</div>

<div class="container hidden" id="mainContainer">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>BeastBet</h2>

    <!-- Botones globales -->
    <button onclick="saveToMongo()">Guardar a Mongo</button>
    <button onclick="loadFromMongo()">Cargar desde Mongo</button>

    <div id="currentCodeInfo" style="margin-bottom:1rem;font-size:0.9rem;">
      (C√≥digo: ???)
    </div>

    <!-- 4 Semanas en ‚Äúacorde√≥n‚Äù -->
    <div class="week-header" id="weekHeader0" onclick="toggleWeek(0)">
      <span>Semana 1 (?)</span>
      <button class="lockBtn" id="weekLock0" onclick="toggleWeekLock(0,event)">[UNLOCK]</button>
    </div>
    <div class="week-content" id="weekContent0"></div>

    <div class="week-header" id="weekHeader1" onclick="toggleWeek(1)">
      <span>Semana 2 (?)</span>
      <button class="lockBtn" id="weekLock1" onclick="toggleWeekLock(1,event)">[UNLOCK]</button>
    </div>
    <div class="week-content" id="weekContent1"></div>

    <div class="week-header" id="weekHeader2" onclick="toggleWeek(2)">
      <span>Semana 3 (?)</span>
      <button class="lockBtn" id="weekLock2" onclick="toggleWeekLock(2,event)">[UNLOCK]</button>
    </div>
    <div class="week-content" id="weekContent2"></div>

    <div class="week-header" id="weekHeader3" onclick="toggleWeek(3)">
      <span>Semana 4 (?)</span>
      <button class="lockBtn" id="weekLock3" onclick="toggleWeekLock(3,event)">[UNLOCK]</button>
    </div>
    <div class="week-content" id="weekContent3"></div>
  </div>

  <!-- CONTENIDO PRINCIPAL (DERECHA) -->
  <div class="main-content">
    <div class="top-bar">
      <h3>Panel Principal</h3>
    </div>
    <div class="scroll-area" id="mainPanel">
      <!-- Aqu√≠ se renderizan los d√≠as o el resumen semanal -->
    </div>
  </div>
</div>

<script>
  /*************************************************************
   * 1) Lista de c√≥digos v√°lidos (NO se muestra al usuario)
   *************************************************************/
  const validCodes = [
    "2468","2486","2648","2684","2846","2864",
    "4268","4286","4628","4682","4826","4862",
    "6248","6284","6428","6482","6824","6842",
    "8246","8264","8426","8462","8624","8642"
  ];

  /*************************************************************
   * 2) Estructura global
   *************************************************************/
  let currentCode="";
  let dataStore={
    weeks:[
      {startDate:"", locked:false, days:[]},
      {startDate:"", locked:false, days:[]},
      {startDate:"", locked:false, days:[]},
      {startDate:"", locked:false, days:[]},
    ]
  };

  /*************************************************************
   * Ojo: mostrar/ocultar PIN
   *************************************************************/
  const pinInput = document.getElementById("pinInput");
  const toggleBtn = document.getElementById("togglePinView");

  toggleBtn.addEventListener("click", ()=>{
    if(pinInput.type==="password"){
      pinInput.type = "text";
    } else {
      pinInput.type = "password";
    }
    pinInput.focus(); // mantener foco
  });

  /*************************************************************
   * 3) Overlay login
   *************************************************************/
  const pinOverlay = document.getElementById("pinOverlay");
  const mainContainer= document.getElementById("mainContainer");
  document.getElementById("btnPinSubmit").addEventListener("click", ()=>{
    let val = pinInput.value.trim();
    // Eliminamos todo lo que no sea d√≠gito
    val = val.replace(/\D/g,"");
    console.log("PIN typed:", val);

    // Verificamos en validCodes
    if(!validCodes.includes(val)){
      alert("C√≥digo incorrecto.");
      return;
    }
    // Si pasa la verificaci√≥n
    currentCode= val;
    document.getElementById("currentCodeInfo").textContent = "(C√≥digo: "+val+")";
    pinOverlay.style.display="none";
    mainContainer.classList.remove("hidden");

    loadLocal();
    initWeeksIfNeeded();
    renderSidebarWeeks();
  });

  /*************************************************************
   * 4) localStorage
   *************************************************************/
  function storeLocal(){
    if(!currentCode) return;
    localStorage.setItem("beastbetData_"+currentCode, JSON.stringify(dataStore));
  }
  function loadLocal(){
    if(!currentCode) return;
    let st= localStorage.getItem("beastbetData_"+currentCode);
    if(st) dataStore= JSON.parse(st);
  }

  /*************************************************************
   * 5) initWeeksIfNeeded()
   *************************************************************/
  function initWeeksIfNeeded(){
    let anyDate= dataStore.weeks.some(w=> w.startDate!=="");
    if(anyDate) return;
    let baseMon= findMondayOfCurrentWeek();
    for(let i=0; i<4; i++){
      let dt= new Date(baseMon);
      dt.setDate(dt.getDate() + i*7);
      dataStore.weeks[i].startDate = dtToYmd(dt);
      dataStore.weeks[i].locked=false;
      dataStore.weeks[i].days=[];
      for(let d=0; d<7; d++){
        let dd={
          pages:[],
          overlook:0, overlookNote:"",
          overlookExtra:[],
          cash:0, sucursal:"",
          credito:0, descuento:0, tickets:0,
          creditTracker:{ pending:[], paid:[] }
        };
        let pArr=[];
        for(let r=1;r<=20;r++){
          pArr.push({
            pageNo:r, centenas:0, pulitos:0,
            pendingPrizes:[], paidPrizes:[],
            totalSalidas:0
          });
        }
        dd.pages=pArr;
        dataStore.weeks[i].days.push(dd);
      }
    }
    storeLocal();
  }
  function findMondayOfCurrentWeek(){
    let now=new Date();
    let dayOfWeek= now.getDay();
    let diff= (dayOfWeek+6)%7;
    let mon= new Date(now);
    mon.setDate(now.getDate()-diff);
    return mon;
  }
  function dtToYmd(dt){
    let y= dt.getFullYear();
    let m= (dt.getMonth()+1).toString().padStart(2,"0");
    let d= dt.getDate().toString().padStart(2,"0");
    return \`\${y}-\${m}-\${d}\`;
  }
  function ymdToDate(str){
    let [y,m,d]= str.split("-");
    return new Date(+y, +m-1, +d);
  }

  /*************************************************************
   * 6) Render ‚ÄúBarra Lateral‚Äù (4 semanas)
   *************************************************************/
  function renderSidebarWeeks(){
    for(let i=0; i<4; i++){
      let w= dataStore.weeks[i];
      let sdt= ymdToDate(w.startDate);
      let edt= new Date(sdt);
      edt.setDate(edt.getDate()+6);
      let sS= formatmmdd(sdt);
      let sE= formatmmdd(edt);

      let headerEl= document.getElementById("weekHeader"+i).querySelector("span");
      headerEl.textContent= "Semana "+(i+1)+" ("+sS+" - "+sE+")";

      // candado
      let lockBtn= document.getElementById("weekLock"+i);
      lockBtn.textContent= w.locked ? "[LOCK]" : "[UNLOCK]";
      lockBtn.classList.toggle("locked", w.locked);

      let wc= document.getElementById("weekContent"+i);
      let dayHtml="";
      let dayNames=["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
      for(let d=0; d<7; d++){
        let dayDt= new Date(sdt);
        dayDt.setDate(dayDt.getDate()+d);
        let ds= formatmmdd(dayDt);
        dayHtml += \`
          <div class="day-item" onclick="selectDay(\${i},\${d})">
            D√≠a \${d+1} - \${dayNames[d]} (\${ds})
          </div>
        \`;
      }
      // Agregamos un "Resumen Semanal"
      dayHtml += \`
        <div class="day-item" style="background:#111;" onclick="selectWeekSummary(\${i})">
          Resumen Semanal
        </div>
      \`;
      wc.innerHTML= dayHtml;
    }
  }
  function formatmmdd(dt){
    let mm= (dt.getMonth()+1).toString().padStart(2,"0");
    let dd= dt.getDate().toString().padStart(2,"0");
    return mm+"/"+dd;
  }
  function toggleWeek(i){
    let wc= document.getElementById("weekContent"+i);
    wc.style.display= (wc.style.display==="block")?"none":"block";
  }
  function toggleWeekLock(i, ev){
    ev.stopPropagation();
    let w= dataStore.weeks[i];
    w.locked= !w.locked;
    storeLocal();
    renderSidebarWeeks();
  }

  /*************************************************************
   * 7) selectDay(i,d) => Muestra reporte diario
   *************************************************************/
  function selectDay(i,d){
    let panel= document.getElementById("mainPanel");
    let w= dataStore.weeks[i];
    let dayData= w.days[d];
    let dayNames=["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
    let baseDt= ymdToDate(w.startDate);
    let dayDt= new Date(baseDt);
    dayDt.setDate(dayDt.getDate()+d);
    let ds= formatmmdd(dayDt);

    let locked= w.locked;
    let title= \`<h2 style="color:var(--accent-color);text-shadow:0 0 3px var(--accent-color);">Reporte Diario - \${dayNames[d]} - \${ds}</h2>\`;
    let buttons= \`
      <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
        <button class="pageBtn" style="background:var(--accent-color);color:#000;"
          onclick="saveDay(\${i},\${d})" \${locked?'disabled':''}>Guardar D√≠a</button>
        <button class="pageBtn" style="background:#f90;color:#000;"
          onclick="resetDay(\${i},\${d})" \${locked?'disabled':''}>Reset D√≠a</button>
        <button class="pageBtn" style="background:#0f0;color:#000;"
          onclick="addPageRow(\${i},\${d})" \${locked?'disabled':''}>+ P√°gina</button>
      </div>
    \`;
    let sucField= \`
      <div style="margin-bottom:0.5rem;">
        <label style="font-weight:bold;">Sucursal:</label>
        <input type="text" style="width:250px;padding:0.3rem;"
          data-week="\${i}" data-day="\${d}" data-field="sucursal"
          value="\${dayData.sucursal}"
          oninput="updateDayStringField(this)" \${locked?'disabled':''}>
      </div>
    \`;

    let html= title + buttons + sucField;
    html += renderPagesTable(i,d);
    html += renderDayTotals(i,d);
    html += renderDayAcordeons(i,d);

    panel.innerHTML= html;
  }
  function saveDay(i,d){
    alert("D√≠a "+(d+1)+" guardado local (placeholder).");
    storeLocal();
  }
  function resetDay(i,d){
    if(!confirm("¬øResetear este d√≠a?")) return;
    let dd={
      pages:[],
      overlook:0, overlookNote:"",
      overlookExtra:[],
      cash:0, sucursal:"",
      credito:0, descuento:0, tickets:0,
      creditTracker:{ pending:[], paid:[] }
    };
    let pArr=[];
    for(let r=1;r<=20;r++){
      pArr.push({
        pageNo:r, centenas:0, pulitos:0,
        pendingPrizes:[], paidPrizes:[],
        totalSalidas:0
      });
    }
    dd.pages=pArr;
    dataStore.weeks[i].days[d]= dd;
    storeLocal();
    selectDay(i,d);
  }
  function addPageRow(i,d){
    let dayData= dataStore.weeks[i].days[d];
    let nextNo= dayData.pages.length+1;
    dayData.pages.push({
      pageNo: nextNo,
      centenas:0, pulitos:0,
      pendingPrizes:[], paidPrizes:[],
      totalSalidas:0
    });
    storeLocal();
    selectDay(i,d);
  }
  function updateDayStringField(input){
    let i= +input.dataset.week;
    let d= +input.dataset.day;
    let field= input.dataset.field;
    dataStore.weeks[i].days[d][field]= input.value;
    storeLocal();
  }

  /*************************************************************
   * 8) Render tabla de p√°ginas
   *************************************************************/
  function renderPagesTable(i,d){
    let w= dataStore.weeks[i];
    let locked= w.locked;
    let dayData= w.days[d];
    let html= \`
    <table style="margin-bottom:1rem;">
      <thead>
        <tr>
          <th>#P√°gina</th>
          <th>Centenas</th>
          <th>Pulitos</th>
          <th>Salidas</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
    \`;
    dayData.pages.forEach((p,idx)=>{
      let cVal= p.centenas||"";
      let puVal= p.pulitos||"";
      let totalCP= p.centenas + p.pulitos;
      let sumPend= p.pendingPrizes.reduce((acc,v)=>acc+v,0);
      let hasPend= sumPend>0;
      let salColor= hasPend ? "var(--purple-color)" : "var(--danger-color)";
      html+=\`
        <tr>
          <td>
            <button class="pageBtn"
              onclick="deletePageRow(\${i},\${d},\${idx})" \${locked?'disabled':''}>
              \${p.pageNo}
            </button>
          </td>
          <td>
            <input type="number" max="900000"
              data-week="\${i}" data-day="\${d}" data-page="\${idx}" data-field="centenas"
              value="\${cVal}"
              onchange="updatePageField(this)"
              \${locked?'disabled':''}
              style="width:100px;">
          </td>
          <td>
            <input type="number" max="900000"
              data-week="\${i}" data-day="\${d}" data-page="\${idx}" data-field="pulitos"
              value="\${puVal}"
              onchange="updatePageField(this)"
              \${locked?'disabled':''}
              style="width:100px;">
          </td>
          <td style="color:\${salColor};cursor:pointer;"
            onclick="openPrizesModal(\${i},\${d},\${idx})">
            $\${p.totalSalidas.toFixed(2)}
          </td>
          <td>$\${totalCP.toFixed(2)}</td>
        </tr>
      \`;
    });
    html+="</tbody></table>";
    return html;
  }
  function deletePageRow(i,d,idx){
    if(!confirm("¬øEliminar esta p√°gina?")) return;
    let dayData= dataStore.weeks[i].days[d];
    dayData.pages.splice(idx,1);
    dayData.pages.forEach((pg,ix)=> pg.pageNo= ix+1);
    storeLocal();
    selectDay(i,d);
  }
  function updatePageField(input){
    let i= +input.dataset.week;
    let d= +input.dataset.day;
    let p= +input.dataset.page;
    let field= input.dataset.field;
    let val= parseFloat(input.value)||0;
    if(val>900000) val=900000;
    dataStore.weeks[i].days[d].pages[p][field]= val;
    storeLocal();
    selectDay(i,d); // Re-render
  }
  function openPrizesModal(i,d,idx){
    // Aqu√≠ abrir√≠as tu modal (Pendientes/Pagados).
    alert("Aqu√≠ abrir√≠as tu modal (Pendientes/Pagados).");
  }

  /*************************************************************
   * 9) Overlook principal + Extra
   *************************************************************/
  function renderDayTotals(i,d){
    let w= dataStore.weeks[i];
    let locked= w.locked;
    let dayData= w.days[d];
    let ovVal= dayData.overlook||0;
    let ovNote= dayData.overlookNote||"";
    return \`
    <div class="totals-section">
      <h3>Totales del D√≠a</h3>
      <div class="form-group">
        <label>Overlook</label>
        <input type="number" max="900000"
          data-week="\${i}" data-day="\${d}" data-field="overlook"
          value="\${ovVal}"
          onchange="updateDayField(this)"
          \${locked?'disabled':''}
          style="width:100px;">
        <input type="text"
          data-week="\${i}" data-day="\${d}" data-field="overlookNote"
          value="\${ovNote}"
          oninput="updateDayStringField(this)"
          \${locked?'disabled':''}
          placeholder="Nota Overlook"
          style="margin-left:8px;width:300px;">
        <button class="pageBtn" style="background:green;margin-left:8px;"
          onclick="addOverlookRow(\${i},\${d})" \${locked?'disabled':''}>Add</button>
        <button class="pageBtn" style="background:red;margin-left:8px;"
          onclick="clearMainOverlook(\${i},\${d})" \${locked?'disabled':''}>Del</button>
      </div>
      <div id="overlookExtraContainer_\${i}_\${d}">
        \${renderOverlookExtraRows(i,d)}
      </div>
      \${renderPartialTotals(i,d)}
    </div>
    \`;
  }
  function addOverlookRow(i,d){
    let dayData= dataStore.weeks[i].days[d];
    dayData.overlookExtra.push({ amount:0, note:"" });
    storeLocal();
    selectDay(i,d);
  }
  function clearMainOverlook(i,d){
    let dayData= dataStore.weeks[i].days[d];
    dayData.overlook=0;
    dayData.overlookNote="";
    storeLocal();
    selectDay(i,d);
  }
  function renderOverlookExtraRows(i,d){
    let w= dataStore.weeks[i];
    let locked= w.locked;
    let dayData= w.days[d];
    let out="";
    dayData.overlookExtra.forEach((row,idx)=>{
      let val=row.amount||0;
      let note=row.note||"";
      out+=\`
        <div class="form-group">
          <label>Overlook</label>
          <input type="number" max="900000"
            data-week="\${i}" data-day="\${d}" data-oidx="\${idx}" data-type="amount"
            value="\${val}"
            onchange="updateOverlookExtra(this)"
            \${locked?'disabled':''}
            style="width:100px;">
          <input type="text"
            data-week="\${i}" data-day="\${d}" data-oidx="\${idx}" data-type="note"
            value="\${note}"
            oninput="updateOverlookExtra(this)"
            \${locked?'disabled':''}
            style="margin-left:8px;width:300px;">
          <button class="pageBtn" style="background:green;margin-left:8px;"
            onclick="addOverlookRow(\${i},\${d})" \${locked?'disabled':''}>Add</button>
          <button class="pageBtn" style="background:red;margin-left:8px;"
            onclick="deleteOverlookRow(\${i},\${d},\${idx})" \${locked?'disabled':''}>Del</button>
        </div>
      \`;
    });
    return out;
  }
  function deleteOverlookRow(i,d,idx){
    let dayData= dataStore.weeks[i].days[d];
    dayData.overlookExtra.splice(idx,1);
    storeLocal();
    selectDay(i,d);
  }
  function updateOverlookExtra(input){
    let i= +input.dataset.week;
    let d= +input.dataset.day;
    let rowIndex= +input.dataset.oidx;
    let dayData= dataStore.weeks[i].days[d];
    let row= dayData.overlookExtra[rowIndex];
    if(input.dataset.type==="amount"){
      let val= parseFloat(input.value)||0;
      if(val>900000) val=900000;
      row.amount= val;
    } else {
      row.note= input.value;
    }
    storeLocal();
    updatePartialTotals(i,d);
  }
  function renderPartialTotals(i,d){
    let t= calcDayTotals(dataStore.weeks[i].days[d]);
    return \`
      <div class="form-group" style="margin-top:0.5rem;">
        <label>Total Salidas</label>
        <input type="text" readonly style="color:var(--danger-color);" value="$\${t.totalSalidas.toFixed(2)}">
      </div>
      <div class="form-group">
        <label>Total Ventas</label>
        <input type="text" readonly value="$\${t.totalVentas.toFixed(2)}">
      </div>
    \`;
  }
  function updatePartialTotals(i,d){
    // Actualiza solo las cifras en pantalla (si quisi√©ramos).
  }
  function calcDayTotals(dayData){
    let tc=0, tp=0, ts=0;
    dayData.pages.forEach(p=>{
      tc+=(p.centenas||0);
      tp+=(p.pulitos||0);
      ts+=(p.totalSalidas||0);
    });
    ts += (dayData.overlook||0);
    dayData.overlookExtra.forEach(r=> ts+=(r.amount||0));
    return {
      totalCentenas: tc,
      totalPulitos: tp,
      totalSalidas: ts,
      totalVentas: tc+tp
    };
  }

  /*************************************************************
   * 10) Cuadre & Cr√©ditos (acordeones)
   *************************************************************/
  function renderDayAcordeons(i,d){
    return \`
      <div class="accordion">
        <div class="accordion-header" onclick="toggleSubSection('cuadre_\${i}_\${d}')">
          Cuadre del D√≠a
        </div>
        <div id="cuadre_\${i}_\${d}" class="accordion-content">
          \${renderCuadreDia(i,d)}
        </div>
      </div>

      <div class="accordion">
        <div class="accordion-header" onclick="toggleSubSection('credit_\${i}_\${d}')">
          Cr√©ditos Otorgados
        </div>
        <div id="credit_\${i}_\${d}" class="accordion-content">
          \${renderCreditSection(i,d)}
        </div>
      </div>
    \`;
  }
  function toggleSubSection(id){
    let el= document.getElementById(id);
    if(!el) return;
    el.style.display= (el.style.display==="none" || !el.style.display) ? "block" : "none";
  }
  function renderCuadreDia(i,d){
    let dayData= dataStore.weeks[i].days[d];
    let t= calcDayTotals(dayData);
    let subT= t.totalVentas - t.totalSalidas;
    let totalPending=0;
    dayData.pages.forEach(pg=>{
      totalPending += pg.pendingPrizes.reduce((a,v)=>a+v,0);
    });
    let sumOpt= dayData.cash + dayData.sucursal + dayData.credito + dayData.descuento + dayData.tickets;
    let netBal= subT - sumOpt + totalPending;
    let nbColor= (netBal<0)?"#0f0":(netBal>0?"#f33":"#fff");

    return \`
      <div class="cuadre-section">
        <h3>Cuadre del D√≠a</h3>
        <div class="form-group">
          <label>Ventas</label>
          <input type="text" readonly value="\${t.totalVentas.toFixed(2)}">
        </div>
        <div class="form-group">
          <label>Salidas</label>
          <input type="text" readonly style="color:var(--danger-color);" value="\${t.totalSalidas.toFixed(2)}">
        </div>
        <div class="form-group">
          <label>SubTotal</label>
          <input type="text" readonly style="color:var(--purple-strong);" value="\${subT.toFixed(2)}">
        </div>
        <div class="form-group">
          <label>PremPend</label>
          <input type="text" readonly style="color:var(--purple-color);" value="\${totalPending.toFixed(2)}">
        </div>

        <div class="form-group">
          <label>Cash</label>
          <input type="number" max="900000"
            data-week="\${i}" data-day="\${d}" data-field="cash"
            value="\${dayData.cash||0}"
            onchange="updateDayField(this)">
        </div>
        <div class="form-group">
          <label>Sucursal</label>
          <input type="number" max="900000"
            data-week="\${i}" data-day="\${d}" data-field="sucursal"
            value="\${dayData.sucursal||0}"
            onchange="updateDayField(this)">
        </div>
        <div class="form-group">
          <label>Cr√©dito (lectura)</label>
          <input type="number" readonly style="color:var(--purple-color);" value="\${dayData.credito||0}">
        </div>
        <div class="form-group">
          <label>Descuento</label>
          <input type="number" max="900000"
            data-week="\${i}" data-day="\${d}" data-field="descuento"
            value="\${dayData.descuento||0}"
            onchange="updateDayField(this)">
        </div>
        <div class="form-group">
          <label>Tickets</label>
          <input type="number" max="900000"
            data-week="\${i}" data-day="\${d}" data-field="tickets"
            value="\${dayData.tickets||0}"
            onchange="updateDayField(this)">
        </div>
        <div class="form-group">
          <label>NetBalance</label>
          <input type="text" readonly style="color:\${nbColor};" value="\${netBal.toFixed(2)}">
        </div>
      </div>
    \`;
  }
  function renderCreditSection(i,d){
    let w= dataStore.weeks[i];
    let locked= w.locked;
    let dayData= w.days[d];
    let c= dayData.creditTracker;
    let pendingHTML="";
    c.pending.forEach((obj,idx)=>{
      pendingHTML += makeCreditRow(i,d,"pending",idx,obj,locked);
    });
    let paidHTML="";
    c.paid.forEach((obj,idx)=>{
      paidHTML += makeCreditRow(i,d,"paid",idx,obj,locked);
    });
    let totalPend= c.pending.reduce((acc,o)=>acc+(o.amount||0),0);
    let totalPaid= c.paid.reduce((acc,o)=>acc+(o.amount||0),0;

    return \`
      <div style="padding:1rem;">
        <h4 style="color:var(--purple-color);">Pendientes</h4>
        <table>
          <thead><tr><th>#</th><th>Cliente</th><th>Monto</th><th></th></tr></thead>
          <tbody>\${pendingHTML}</tbody>
        </table>
        <button class="addPrizeBtn" onclick="addCreditItem(\${i},\${d},'pending')" \${locked?'disabled':''}>+Pend</button>
        <p>Total Pend: <span style="color:var(--purple-color);">$\${totalPend.toFixed(2)}</span></p>

        <h4 style="color:var(--danger-color);">Pagados</h4>
        <table>
          <thead><tr><th>#</th><th>Cliente</th><th>Monto</th><th></th></tr></thead>
          <tbody>\${paidHTML}</tbody>
        </table>
        <button class="addPrizeBtn" style="color:var(--danger-color);border-color:var(--danger-color);"
          onclick="addCreditItem(\${i},\${d},'paid')" \${locked?'disabled':''}>+Paid</button>
        <p>Total Paid: <span style="color:var(--danger-color);">$\${totalPaid.toFixed(2)}</span></p>
      </div>
    \`;
  }
  function makeCreditRow(i,d,type,idx,obj,locked){
    let client= obj.client||"";
    let amt= obj.amount||0;
    let arrowBtn= (type==="pending")
      ? \`<button class="paidBtn" onclick="moveCreditItem(\${i},\${d},\${idx},'pending')" \${locked?'disabled':''}>‚ÜíPag</button>\`
      : \`<button class="pendingBtn" onclick="moveCreditItem(\${i},\${d},\${idx},'paid')" \${locked?'disabled':''}>‚ÜíPend</button>\`;

    return \`
      <tr>
        <td>
          <button class="pageBtn" style="font-size:0.9rem;"
            onclick="deleteCreditRow(\${i},\${d},'\${type}',\${idx})"
            \${locked?'disabled':''}>
            \${idx+1}
          </button>
        </td>
        <td>
          <input type="text" maxlength="10" style="width:80px;"
            data-week="\${i}" data-day="\${d}" data-type="\${type}" data-idx="\${idx}" data-field="client"
            value="\${client}"
            oninput="updateCreditItem(this)"
            \${locked?'disabled':''}>
        </td>
        <td>
          <input type="number" max="900000" style="width:80px;"
            data-week="\${i}" data-day="\${d}" data-type="\${type}" data-idx="\${idx}" data-field="amount"
            value="\${amt}"
            onchange="updateCreditItem(this)"
            \${locked?'disabled':''}>
        </td>
        <td>\${arrowBtn}</td>
      </tr>
    \`;
  }
  function addCreditItem(i,d,type){
    let dayData= dataStore.weeks[i].days[d];
    dayData.creditTracker[type].push({ client:"", amount:0 });
    storeLocal();
    selectDay(i,d);
  }
  function deleteCreditRow(i,d,type,idx){
    if(!confirm("¬øEliminar registro de cr√©dito?")) return;
    let dayData= dataStore.weeks[i].days[d];
    dayData.creditTracker[type].splice(idx,1);
    storeLocal();
    selectDay(i,d);
  }
  function updateCreditItem(input){
    let i= +input.dataset.week;
    let d= +input.dataset.day;
    let type= input.dataset.type;
    let idx= +input.dataset.idx;
    let field= input.dataset.field;
    let dayData= dataStore.weeks[i].days[d];
    let item= dayData.creditTracker[type][idx];
    if(field==="client"){
      item.client= input.value.substring(0,10);
    } else {
      let val= parseFloat(input.value)||0;
      if(val>900000) val=900000;
      item.amount= val;
    }
    // Recalcular ‚ÄúdayData.credito‚Äù = sum(pending)
    dayData.credito= dayData.creditTracker.pending.reduce((acc,o)=>acc+(o.amount||0),0);
    storeLocal();
  }
  function moveCreditItem(i,d,idx,fromType){
    let dayData= dataStore.weeks[i].days[d];
    let item= dayData.creditTracker[fromType][idx];
    dayData.creditTracker[fromType].splice(idx,1);
    if(fromType==="pending"){
      dayData.creditTracker.paid.push(item);
    } else {
      dayData.creditTracker.pending.push(item);
    }
    dayData.credito= dayData.creditTracker.pending.reduce((acc,o)=>acc+(o.amount||0),0);
    storeLocal();
    selectDay(i,d);
  }

  /*************************************************************
   * 11) Resumen Semanal
   *************************************************************/
  function selectWeekSummary(i){
    let panel= document.getElementById("mainPanel");
    let html= \`<h2 style="color:var(--accent-color);text-shadow:0 0 3px var(--accent-color);">Resumen Semanal (Semana \${i+1})</h2>\`;
    html += renderWeeklySummary(i);
    panel.innerHTML= html;
  }
  function renderWeeklySummary(i){
    let w= dataStore.weeks[i];
    let sumCent=0, sumPul=0, sumSal=0, sumVent=0;
    let sumPendAll=0, sumCash=0, sumSuc=0, sumCred=0, sumDesc=0, sumTic=0;
    for(let d=0; d<7; d++){
      let dayData= w.days[d];
      let t= calcDayTotals(dayData);
      sumCent+= t.totalCentenas;
      sumPul += t.totalPulitos;
      sumSal += t.totalSalidas;
      sumVent+= t.totalVentas;

      let dayPend=0;
      dayData.pages.forEach(pg=>{
        dayPend += pg.pendingPrizes.reduce((a,v)=>a+v,0);
      });
      sumPendAll+= dayPend;
      sumCash+= dayData.cash;
      sumSuc+= parseFloat(dayData.sucursal)||0;
      sumCred+= dayData.credito;
      sumDesc+= dayData.descuento;
      sumTic += dayData.tickets;
    }
    let c25= sumCent*0.25;
    let p10= sumPul*0.10;
    let totalCom= c25+p10;
    let subTotal= sumVent - (sumSal + totalCom);
    let balOfic= subTotal;
    let boColor= (balOfic>0)?"#f33":(balOfic<0?"#0f0":"#fff");

    return \`
      <table>
        <thead>
          <tr>
            <th>Centenas</th>
            <th>Pulitos</th>
            <th>Salidas</th>
            <th>Ventas</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>$\${sumCent.toFixed(2)}</td>
            <td>$\${sumPul.toFixed(2)}</td>
            <td style="color:var(--danger-color);">$\${sumSal.toFixed(2)}</td>
            <td>$\${sumVent.toFixed(2)}</td>
          </tr>
        </tbody>
      </table>
      <div style="margin:0.5rem 0;">
        <div>Total Ventas: $\${sumVent.toFixed(2)}</div>
        <div>Centenas 25%: $\${c25.toFixed(2)}</div>
        <div>Pulitos 10%: $\${p10.toFixed(2)}</div>
        <div>Total Comisi√≥n: $\${totalCom.toFixed(2)}</div>
        <div style="color:var(--danger-color);">Total Salidas: $\${sumSal.toFixed(2)}</div>
        <div style="color:var(--purple-strong);">Sub Total: $\${subTotal.toFixed(2)}</div>
      </div>
      <hr/>
      <h3 style="color:var(--accent-color);text-shadow:0 0 3px var(--accent-color);">Cuadre Sucursal (Semana \${i+1})</h3>
      <div>PremPend (sum): <span style="color:var(--purple-color);">$\${sumPendAll.toFixed(2)}</span></div>
      <div>Cash (sum): $\${sumCash.toFixed(2)}</div>
      <div>Sucursal (sum): $\${sumSuc.toFixed(2)}</div>
      <div>Cr√©dito (sum): <span style="color:var(--purple-color);">$\${sumCred.toFixed(2)}</span></div>
      <div>Descuento (sum): $\${sumDesc.toFixed(2)}</div>
      <div>Tickets (sum): $\${sumTic.toFixed(2)}</div>
      <div>Balance Oficina: <span style="color:\${boColor};">$\${balOfic.toFixed(2)}</span></div>
    \`;
  }

  /*************************************************************
   * 12) Guardar / Cargar en Mongo
   *************************************************************/
  async function saveToMongo(){
    if(!currentCode){
      alert("No hay c√≥digo de acceso!");
      return;
    }
    try{
      let resp= await fetch("/api/reportes_"+currentCode, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(dataStore)
      });
      let j= await resp.json();
      if(j.error){
        alert("Error: "+j.error);
      } else {
        alert("Guardado en Mongo con √©xito.");
      }
    } catch(e){
      console.error(e);
      alert("Error POST /api/reportes_{code}");
    }
  }
  async function loadFromMongo(){
    if(!currentCode){
      alert("No hay c√≥digo de acceso!");
      return;
    }
    try{
      let resp= await fetch("/api/reportes_"+currentCode);
      let j= await resp.json();
      if(j.error){
        alert("Error: "+j.error);
        return;
      }
      if(j.notFound){
        alert("No se encontr√≥ data en Mongo para este code");
        return;
      }
      dataStore= j.data;
      storeLocal();
      renderSidebarWeeks();
      document.getElementById("mainPanel").innerHTML=
        "<h2 style='color:var(--accent-color);'>Data cargada desde Mongo. Selecciona Semana/D√≠a.</h2>";
    } catch(e){
      console.error(e);
      alert("Error GET /api/reportes_{code}");
    }
  }
</script>

</body>
</html>
